<!-- templates/view_attempts.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>انتخاب تلاش آزمون</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap RTL -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <!-- Optional Persian font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --card:#fff; --border:#e9edf3; --muted:#6b7b8c;
    }
    *{ box-sizing: border-box; }
    body{
      font-family:'Vazirmatn',sans-serif;
      background:#f7f8fc;
      color:#243447;
    }
    .page{
      max-width:900px;
      margin:0 auto;
      padding:clamp(16px,4vw,32px);
    }
    .page h3{
      font-weight:800;
      margin-bottom:clamp(12px,2.5vw,18px);
    }
    .hint{
      color:var(--muted);
      margin-bottom:clamp(12px,2.5vw,18px);
    }

    .list-group{
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 4px 16px rgba(0,0,0,.06);
      background:var(--card);
    }
    .list-group-item{
      border-color:var(--border);
      padding:clamp(8px,2.5vw,14px);
    }

    .attempt-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.6rem;
      width:100%;
      min-height:clamp(44px,10vw,56px);
      font-weight:700;
      font-size:clamp(14px,3.6vw,16px);
      border-radius:10px;
    }
    .attempt-meta{
      display:flex;
      flex-wrap:wrap;
      gap:.5rem 1rem;
      align-items:center;
      justify-content:center;
    }
    .attempt-chip{
      background:#eef2ff;
      color:#253046;
      padding:.25rem .6rem;
      border-radius:999px;
      font-weight:700;
    }
    .attempt-date{
      color:#0b3866;
    }
    .attempt-name{
      color:#4b5563;
    }

    .back-wrap{
      display:flex;
      justify-content:center;
      margin-top:clamp(14px,3.5vw,20px);
    }
    @media (max-width:480px){
      .attempt-meta{ justify-content:space-between; }
    }
  </style>
</head>
<body>
  <main class="page">
    <h3>تلاش‌های یافت‌شده برای آزمون: {{ test_names[test_code] }}</h3>

    {% if attempts %}
      <p class="hint">لطفاً یکی از تلاش‌ها را برای مشاهدهٔ نتایج انتخاب کنید:</p>
      <ul class="list-group">
        {% for attempt in attempts %}
          <li class="list-group-item">
            <form method="POST" action="/results" class="attempt-form m-0">
              <input type="hidden" name="national_id" value="{{ national_id }}">
              <input type="hidden" name="test_code" value="{{ test_code }}">
              <input type="hidden" name="timestamp" value="{{ attempt['Timestamp'] }}">
              <input type="hidden" name="gender" value="{{ attempt['جنسیت'] }}">
              <input type="hidden" name="phone" value="{{ attempt['شماره تلفن'] }}">

              <!-- We render the Persian date + name via JS for best formatting -->
              <button type="submit"
                      class="btn btn-outline-primary attempt-btn"
                      data-timestamp="{{ attempt['Timestamp'] | e }}"
                      data-name="{{ name | default(attempt.get('نام و نام خانوادگی', 'کاربر')) | e }}">
                <span class="attempt-meta">
                  <span class="attempt-chip attempt-date">...</span>
                  <span class="attempt-chip attempt-name">...</span>
                </span>
              </button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-danger">هیچ تلاش فعالی یافت نشد.</p>
    {% endif %}

    <div class="back-wrap">
      <a href="/" class="btn btn-secondary">بازگشت به خانه</a>
    </div>
  </main>

  <script>
    // Convert gregorian timestamp -> Persian date (fa-IR, Persian calendar)
    // Works for typical ISO strings. Has fallbacks if parsing fails.
    (function(){
      const formatter = new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
        year: 'numeric',
        month: 'long',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      function parseTimestamp(ts){
        // Normalize common formats: "YYYY-MM-DD HH:mm:ss" -> "YYYY-MM-DDTHH:mm:ss"
        if (typeof ts === 'string' && ts.indexOf(' ') > -1 && ts.indexOf('T') === -1) {
          ts = ts.replace(' ', 'T');
        }
        // Some CSV exports include slashes or timezone-less formats; Date will try its best.
        const d = new Date(ts);
        return isNaN(d.getTime()) ? null : d;
      }

      document.querySelectorAll('.attempt-btn').forEach(btn => {
        const ts = btn.getAttribute('data-timestamp') || '';
        const nm = btn.getAttribute('data-name') || 'کاربر';

        const dateEl = btn.querySelector('.attempt-date');
        const nameEl = btn.querySelector('.attempt-name');

        const d = parseTimestamp(ts);
        if (d) {
          // Format to Persian calendar & digits
          dateEl.textContent = formatter.format(d);
        } else {
          // Fallback: raw string
          dateEl.textContent = ts || 'تاریخ نامشخص';
        }
        nameEl.textContent = nm;
      });
    })();
  </script>
</body>
</html>
